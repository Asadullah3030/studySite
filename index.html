<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IATI RYK - Study Resources</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--green:#10b981;--dark:#059669;--gray:#6b7280;--light:#f3f4f6;--white:#fff;--red:#ef4444}
        body{font-family:'Poppins',sans-serif;background:var(--light);min-height:100vh}
        
        /* Buttons */
        .admin-btn{position:fixed;bottom:15px;right:15px;background:var(--green);color:#fff;border:none;padding:10px 20px;border-radius:25px;font-weight:700;cursor:pointer;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.2)}
        .refresh-btn{position:fixed;bottom:15px;left:15px;background:#3b82f6;color:#fff;border:none;padding:10px 20px;border-radius:25px;font-weight:700;cursor:pointer;z-index:100}
        
        /* Header */
        .header{background:linear-gradient(135deg,var(--green),var(--dark));color:#fff;padding:30px 15px;text-align:center}
        .header h1{font-size:1.5em;margin-bottom:5px}
        .header p{opacity:.9;font-size:.9em}
        
        /* Container */
        .container{max-width:1200px;margin:0 auto;padding:20px 15px}
        
        /* Stats */
        .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
        .stat{background:#fff;padding:15px;border-radius:12px;text-align:center}
        .stat-num{font-size:1.5em;font-weight:700;color:var(--green)}
        .stat-label{font-size:.75em;color:var(--gray)}
        
        /* Search */
        .search{margin-bottom:20px}
        .search input{width:100%;padding:12px 15px;border:2px solid #e5e7eb;border-radius:25px;font-size:1em}
        .search input:focus{outline:none;border-color:var(--green)}
        
        /* Breadcrumb */
        .breadcrumb{background:#fff;padding:12px 15px;border-radius:10px;margin-bottom:15px;display:none}
        .breadcrumb span{cursor:pointer;color:var(--green);font-weight:600}
        
        /* Grid */
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px}
        
        /* Folder */
        .folder{background:#fff;padding:20px 15px;border-radius:15px;text-align:center;cursor:pointer;transition:transform .2s}
        .folder:active{transform:scale(.95)}
        .folder-icon{font-size:2.5em;margin-bottom:10px}
        .folder-name{font-weight:700;font-size:.9em;color:#1f2937}
        .folder-count{font-size:.8em;color:var(--gray)}
        
        /* File */
        .file{background:#fff;border-radius:15px;overflow:hidden}
        .file-thumb{height:120px;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:2.5em;color:#fff;position:relative}
        .file-thumb img{width:100%;height:100%;object-fit:cover}
        .file-type{position:absolute;top:8px;right:8px;background:#fff;padding:3px 10px;border-radius:10px;font-size:.7em;font-weight:700}
        .file-info{padding:12px}
        .file-title{font-weight:700;font-size:.85em;margin-bottom:8px;color:#1f2937}
        .file-meta{font-size:.75em;color:var(--gray);margin-bottom:10px}
        .file-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .file-btns button{padding:8px;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:.8em}
        .btn-view{background:var(--light);color:#1f2937}
        .btn-download{background:var(--green);color:#fff}
        .btn-delete{background:var(--red);color:#fff;grid-column:1/-1}
        
        /* Modal */
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:200;align-items:center;justify-content:center}
        .modal-box{background:#fff;width:90%;max-width:400px;padding:25px;border-radius:20px;text-align:center}
        .modal-box h2{margin-bottom:15px}
        .modal-box input,.modal-box select{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:10px;margin-bottom:12px;font-size:1em}
        .modal-box button{width:100%;padding:12px;border:none;border-radius:10px;font-weight:700;cursor:pointer;margin-top:5px}
        .btn-primary{background:var(--green);color:#fff}
        .btn-secondary{background:var(--light);color:#1f2937}
        .btn-danger{background:var(--red);color:#fff}
        .close-modal{position:absolute;top:15px;right:20px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#fff}
        
        /* Preview */
        .preview-content{width:95%;height:90%;max-width:1000px;background:#fff;border-radius:15px;overflow:hidden;display:flex;flex-direction:column}
        .preview-header{background:var(--green);color:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center}
        .preview-body{flex:1;display:flex;align-items:center;justify-content:center;background:var(--light);overflow:auto}
        .preview-body img,.preview-body video{max-width:100%;max-height:100%}
        .preview-body iframe{width:100%;height:100%;border:none}
        
        /* Upload Area */
        .upload-area{border:2px dashed #e5e7eb;padding:30px;border-radius:15px;text-align:center;cursor:pointer;margin-bottom:15px}
        .upload-area.active{border-color:var(--green);background:rgba(16,185,129,.05)}
        
        /* Messages */
        .toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);padding:12px 25px;border-radius:25px;color:#fff;font-weight:600;z-index:300;display:none}
        .toast.success{background:var(--green)}
        .toast.error{background:var(--red)}
        
        .no-files{grid-column:1/-1;text-align:center;padding:40px;color:var(--gray)}
        
        /* Footer */
        .footer{text-align:center;padding:30px;margin-top:30px;color:var(--gray);font-size:.85em}
        
        /* Progress */
        .progress{height:8px;background:#e5e7eb;border-radius:10px;overflow:hidden;margin:15px 0;display:none}
        .progress-bar{height:100%;background:var(--green);width:0;transition:width .3s}
        
        /* Admin Panel */
        .admin-panel{display:none;position:fixed;inset:0;background:#fff;z-index:150;overflow-y:auto}
        .admin-header{background:var(--green);color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
        .admin-content{padding:20px}
        .admin-section{background:var(--light);padding:20px;border-radius:15px;margin-bottom:20px}
        .admin-section h3{margin-bottom:15px}
        .admin-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px}
        
        @media(max-width:500px){
            .stats{grid-template-columns:repeat(3,1fr)}
            .grid{grid-template-columns:repeat(2,1fr)}
            .admin-grid{grid-template-columns:1fr}
        }
    </style>
</head>
<body>

<button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
<button class="admin-btn" id="adminBtn" onclick="openLogin()">üîê Admin</button>
<div class="toast" id="toast"></div>

<!-- Login Modal -->
<div class="modal" id="loginModal">
    <button class="close-modal" onclick="closeModal('loginModal')">‚úï</button>
    <div class="modal-box">
        <h2>üîê Admin Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button class="btn-primary" onclick="login()">Login</button>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal" id="uploadModal">
    <button class="close-modal" onclick="closeModal('uploadModal')">‚úï</button>
    <div class="modal-box">
        <h2>üì§ Upload File</h2>
        <input type="text" id="fileTitle" placeholder="File Title">
        <select id="fileFolder">
            <option value="">-- Select Folder --</option>
            <option value="first-year">First Year</option>
            <option value="second-year">Second Year</option>
            <option value="third-year">Third Year</option>
            <option value="fourth-year">Fourth Year</option>
            <option value="exam-papers">Past Papers</option>
            <option value="reference">Reference</option>
            <option value="photos">Photos</option>
            <option value="videos">Videos</option>
            <option value="root">Main Page</option>
        </select>
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            üìÅ Click to select file<br><small>(Max 10MB)</small>
            <div id="fileName"></div>
        </div>
        <input type="file" id="fileInput" style="display:none" accept=".pdf,.jpg,.jpeg,.png,.gif,.mp4,.webm" onchange="selectFile(event)">
        <div class="progress" id="progress"><div class="progress-bar" id="progressBar"></div></div>
        <button class="btn-primary" id="uploadBtn" onclick="uploadFile()">Upload</button>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal" id="previewModal">
    <div class="preview-content">
        <div class="preview-header">
            <span id="previewTitle">Preview</span>
            <button onclick="closeModal('previewModal')" style="background:rgba(255,255,255,.2);border:none;color:#fff;padding:8px 15px;border-radius:20px;cursor:pointer">‚úï Close</button>
        </div>
        <div class="preview-body" id="previewBody"></div>
    </div>
</div>

<!-- Delete Confirm -->
<div class="modal" id="deleteModal">
    <div class="modal-box">
        <h2>‚ö†Ô∏è Delete?</h2>
        <p id="deleteText">Are you sure?</p>
        <button class="btn-danger" id="confirmDelete">Yes, Delete</button>
        <button class="btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
    </div>
</div>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
    <div class="admin-header">
        <span>üõ†Ô∏è Admin Panel (<span id="adminName"></span>)</span>
        <div>
            <button onclick="openModal('uploadModal')" style="background:#fff;color:var(--green);border:none;padding:8px 15px;border-radius:20px;font-weight:700;cursor:pointer;margin-right:5px">üì§ Upload</button>
            <button onclick="closeAdmin()" style="background:rgba(255,255,255,.2);border:none;color:#fff;padding:8px 15px;border-radius:20px;cursor:pointer;margin-right:5px">‚úï</button>
            <button onclick="logout()" style="background:var(--red);border:none;color:#fff;padding:8px 15px;border-radius:20px;cursor:pointer">Logout</button>
        </div>
    </div>
    <div class="admin-content">
        <div class="admin-section">
            <h3>üìÇ All Files (<span id="fileCount">0</span>)</h3>
            <div class="admin-grid" id="adminFiles"></div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="header">
    <h1>üåæ IATI - Rahim Yar Khan</h1>
    <p>Study Resources Hub</p>
</div>

<div class="container">
    <div class="stats">
        <div class="stat">
            <div class="stat-num" id="statFolders">8</div>
            <div class="stat-label">Folders</div>
        </div>
        <div class="stat">
            <div class="stat-num" id="statFiles">0</div>
            <div class="stat-label">Files</div>
        </div>
        <div class="stat">
            <div class="stat-num" id="statDownloads">0</div>
            <div class="stat-label">Downloads</div>
        </div>
    </div>

    <div class="search">
        <input type="text" id="searchBox" placeholder="üîç Search files...">
    </div>

    <div class="breadcrumb" id="breadcrumb">
        <span onclick="goHome()">üè† Home</span> ‚Ä∫ <span id="currentFolderName"></span>
    </div>

    <div class="grid" id="mainGrid"></div>
</div>

<div class="footer">
    <p>üë®‚Äçüíº Asadullah Ashraf | üë®‚Äçüíª Muhammad Kamran</p>
    <p>¬© 2025 IATI RYK</p>
</div>

<script>
// Config
const CONFIG = {
    CLOUD: 'dmifnqtlx',
    PRESET: 'iati_upload',
    DB: 'https://api.npoint.io/cfe3a72212ad11e74b28',
    MAX_SIZE: 10 * 1024 * 1024,
    ADMINS: [
        {u: 'asad', p: 'asad123'},
        {u: 'kamran', p: 'kamran123'}
    ]
};

// State
let files = [];
let folder = 'root';
let admin = null;
let selFile = null;
let delId = null;

const FOLDERS = [
    {id:'first-year',name:'First Year',icon:'üìò'},
    {id:'second-year',name:'Second Year',icon:'üìó'},
    {id:'third-year',name:'Third Year',icon:'üìô'},
    {id:'fourth-year',name:'Fourth Year',icon:'üìï'},
    {id:'exam-papers',name:'Past Papers',icon:'üìù'},
    {id:'reference',name:'Reference Books',icon:'üìö'},
    {id:'photos',name:'Photos',icon:'üì∑'},
    {id:'videos',name:'Videos',icon:'üé•'}
];

// Init
window.onload = async () => {
    checkLogin();
    await loadData();
    render();
};

// Data
async function loadData() {
    try {
        const r = await fetch(CONFIG.DB + '?t=' + Date.now());
        files = await r.json();
        if (!Array.isArray(files)) files = [];
    } catch(e) {
        files = [];
    }
}

async function saveData() {
    try {
        await fetch(CONFIG.DB, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(files)
        });
        return true;
    } catch(e) {
        return false;
    }
}

async function refreshData() {
    toast('Refreshing...', 'success');
    await loadData();
    render();
    if (admin) renderAdmin();
    toast('Updated! ‚úÖ', 'success');
}

// Auth
function checkLogin() {
    const s = localStorage.getItem('admin');
    if (s) {
        const d = JSON.parse(s);
        if (Date.now() - d.t < 86400000) {
            admin = d.u;
            updateAdminBtn();
        }
    }
}

function openLogin() {
    if (admin) {
        openAdmin();
    } else {
        openModal('loginModal');
    }
}

function login() {
    const u = document.getElementById('username').value.toLowerCase().trim();
    const p = document.getElementById('password').value;
    const found = CONFIG.ADMINS.find(a => a.u === u && a.p === p);
    
    if (found) {
        admin = u;
        localStorage.setItem('admin', JSON.stringify({u, t: Date.now()}));
        closeModal('loginModal');
        updateAdminBtn();
        toast('Welcome ' + u + '! üëã', 'success');
        openAdmin();
    } else {
        toast('Wrong credentials!', 'error');
    }
}

function logout() {
    admin = null;
    localStorage.removeItem('admin');
    updateAdminBtn();
    closeAdmin();
    toast('Logged out!', 'success');
}

function updateAdminBtn() {
    document.getElementById('adminBtn').textContent = admin ? 'üë§ ' + admin : 'üîê Admin';
}

// Admin Panel
function openAdmin() {
    document.getElementById('adminName').textContent = admin;
    document.getElementById('adminPanel').style.display = 'block';
    renderAdmin();
}

function closeAdmin() {
    document.getElementById('adminPanel').style.display = 'none';
}

function renderAdmin() {
    const g = document.getElementById('adminFiles');
    document.getElementById('fileCount').textContent = files.length;
    
    if (files.length === 0) {
        g.innerHTML = '<p class="no-files">No files yet</p>';
        return;
    }
    
    g.innerHTML = files.map(f => `
        <div class="file">
            <div class="file-thumb" style="height:80px;font-size:2em">
                ${f.type === 'image' ? '<img src="'+f.url+'">' : getIcon(f.type)}
            </div>
            <div class="file-info">
                <div class="file-title">${f.title}</div>
                <div class="file-meta">üìÅ ${f.folder} | üë§ ${f.by || '?'}</div>
                <button class="btn-delete" onclick="confirmDel('${f.id}')" style="width:100%;margin-top:8px">üóëÔ∏è Delete</button>
            </div>
        </div>
    `).join('');
}

// Upload
function selectFile(e) {
    const f = e.target.files[0];
    if (!f) return;
    
    if (f.size > CONFIG.MAX_SIZE) {
        toast('File too big! Max 10MB', 'error');
        selFile = null;
        document.getElementById('fileName').innerHTML = '';
        return;
    }
    
    selFile = f;
    document.getElementById('fileName').innerHTML = '<br>‚úÖ ' + f.name;
}

async function uploadFile() {
    if (!selFile) return toast('Select a file!', 'error');
    
    const title = document.getElementById('fileTitle').value.trim();
    const fol = document.getElementById('fileFolder').value;
    
    if (!title || !fol) return toast('Fill all fields!', 'error');
    
    const btn = document.getElementById('uploadBtn');
    const prog = document.getElementById('progress');
    const bar = document.getElementById('progressBar');
    
    btn.disabled = true;
    btn.textContent = 'Uploading...';
    prog.style.display = 'block';
    
    try {
        const fd = new FormData();
        fd.append('file', selFile);
        fd.append('upload_preset', CONFIG.PRESET);
        fd.append('folder', 'iati/' + fol);
        
        const xhr = new XMLHttpRequest();
        
        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                bar.style.width = Math.round(e.loaded/e.total*100) + '%';
            }
        };
        
        const res = await new Promise((ok, no) => {
            xhr.onload = () => xhr.status === 200 ? ok(JSON.parse(xhr.responseText)) : no();
            xhr.onerror = () => no();
            xhr.open('POST', 'https://api.cloudinary.com/v1_1/' + CONFIG.CLOUD + '/auto/upload');
            xhr.send(fd);
        });
        
        let type = 'pdf';
        if (res.resource_type === 'image') type = 'image';
        if (res.resource_type === 'video') type = 'video';
        
        files.push({
            id: 'f' + Date.now(),
            title,
            type,
            size: formatSize(res.bytes),
            downloads: 0,
            url: res.secure_url,
            folder: fol,
            by: admin,
            date: new Date().toISOString()
        });
        
        await saveData();
        toast('Uploaded! ‚úÖ', 'success');
        
        // Reset
        document.getElementById('fileTitle').value = '';
        document.getElementById('fileFolder').value = '';
        document.getElementById('fileName').innerHTML = '';
        document.getElementById('fileInput').value = '';
        selFile = null;
        prog.style.display = 'none';
        bar.style.width = '0';
        
        render();
        renderAdmin();
        closeModal('uploadModal');
        
    } catch(e) {
        toast('Upload failed!', 'error');
    }
    
    btn.disabled = false;
    btn.textContent = 'Upload';
}

// Delete
function confirmDel(id) {
    delId = id;
    const f = files.find(x => x.id === id);
    document.getElementById('deleteText').textContent = 'Delete "' + f?.title + '"?';
    openModal('deleteModal');
}

document.getElementById('confirmDelete').onclick = async () => {
    if (!delId) return;
    files = files.filter(f => f.id !== delId);
    await saveData();
    toast('Deleted!', 'success');
    closeModal('deleteModal');
    render();
    renderAdmin();
    delId = null;
};

// Render
function render() {
    updateStats();
    
    const search = document.getElementById('searchBox').value.toLowerCase();
    const bc = document.getElementById('breadcrumb');
    const grid = document.getElementById('mainGrid');
    
    if (search) {
        bc.style.display = 'none';
        const res = files.filter(f => f.title.toLowerCase().includes(search));
        renderFiles(res);
    } else if (folder === 'root') {
        bc.style.display = 'none';
        renderFolders();
    } else {
        bc.style.display = 'block';
        document.getElementById('currentFolderName').textContent = FOLDERS.find(f => f.id === folder)?.name || folder;
        renderFiles(files.filter(f => f.folder === folder));
    }
}

function renderFolders() {
    const grid = document.getElementById('mainGrid');
    grid.innerHTML = FOLDERS.map(f => {
        const count = files.filter(x => x.folder === f.id).length;
        return `
            <div class="folder" onclick="openFolder('${f.id}')">
                <div class="folder-icon">${f.icon}</div>
                <div class="folder-name">${f.name}</div>
                <div class="folder-count">${count} files</div>
            </div>
        `;
    }).join('');
    
    // Add root files
    const rootFiles = files.filter(f => f.folder === 'root');
    if (rootFiles.length > 0) {
        grid.innerHTML += rootFiles.map(f => fileCard(f)).join('');
    }
}

function renderFiles(list) {
    const grid = document.getElementById('mainGrid');
    if (list.length === 0) {
        grid.innerHTML = '<p class="no-files">üì≠ No files here</p>';
        return;
    }
    grid.innerHTML = list.map(f => fileCard(f)).join('');
}

function fileCard(f) {
    return `
        <div class="file">
            <div class="file-thumb" style="background:${f.type==='video'?'#ec4899':f.type==='image'?'#3b82f6':'var(--green)'}">
                ${f.type === 'image' ? '<img src="'+f.url+'">' : getIcon(f.type)}
                <span class="file-type">${f.type.toUpperCase()}</span>
            </div>
            <div class="file-info">
                <div class="file-title">${f.title}</div>
                <div class="file-meta">üì¶ ${f.size} | ‚¨áÔ∏è ${f.downloads}</div>
                <div class="file-btns">
                    <button class="btn-view" onclick="preview('${f.id}')">üëÅÔ∏è</button>
                    <button class="btn-download" onclick="download('${f.id}')">‚¨áÔ∏è</button>
                </div>
            </div>
        </div>
    `;
}

function getIcon(type) {
    return {pdf:'üìÑ',image:'üñºÔ∏è',video:'üé•'}[type] || 'üìÅ';
}

function updateStats() {
    document.getElementById('statFiles').textContent = files.length;
    const dl = files.reduce((s,f) => s + (f.downloads||0), 0);
    document.getElementById('statDownloads').textContent = dl > 999 ? (dl/1000).toFixed(1)+'K' : dl;
}

// Navigation
function openFolder(id) {
    folder = id;
    render();
    window.scrollTo({top: 200, behavior: 'smooth'});
}

function goHome() {
    folder = 'root';
    document.getElementById('searchBox').value = '';
    render();
}

// Preview & Download
function preview(id) {
    const f = files.find(x => x.id === id);
    if (!f) return;
    
    document.getElementById('previewTitle').textContent = f.title;
    const body = document.getElementById('previewBody');
    
    if (f.type === 'image') body.innerHTML = '<img src="'+f.url+'">';
    else if (f.type === 'video') body.innerHTML = '<video src="'+f.url+'" controls></video>';
    else if (f.type === 'pdf') body.innerHTML = '<iframe src="'+f.url+'"></iframe>';
    else body.innerHTML = '<p>Cannot preview</p>';
    
    openModal('previewModal');
}

function download(id) {
    const f = files.find(x => x.id === id);
    if (!f) return;
    
    f.downloads = (f.downloads||0) + 1;
    saveData();
    render();
    
    window.open(f.url, '_blank');
    toast('Download started!', 'success');
}

// Utils
function openModal(id) {
    document.getElementById(id).style.display = 'flex';
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
    if (id === 'previewModal') {
        document.getElementById('previewBody').innerHTML = '';
    }
}

function toast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + type;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 2500);
}

function formatSize(b) {
    if (b < 1024) return b + 'B';
    if (b < 1048576) return (b/1024).toFixed(1) + 'KB';
    return (b/1048576).toFixed(1) + 'MB';
}

// Search
document.getElementById('searchBox').oninput = () => render();

// Close modals on outside click
window.onclick = (e) => {
    ['loginModal','uploadModal','previewModal','deleteModal'].forEach(id => {
        if (e.target === document.getElementById(id)) closeModal(id);
    });
};
</script>
</body>
</html>